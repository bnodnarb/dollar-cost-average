<html>
<head>

<style>
  input, button, select {
    width: 250px;
    height: 30px;
  }
</style>

  <script src='https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js'></script>
  <script src = 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js'></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>

  <script>

    window.onload=function(){
      new ClipboardJS('.btn');
    }

    var api_key = '6TwLGq5lB5deO5ZDTN692lHojSqU0hdCL98MZRMqq86XIr2mnlIAVYqaSsMAV65E'
    var secret = 'tkmmkv2soTrwUA7goRCLvFMumVbRdrxNIElP1tNUGTlVhbf2GbnKBImaza1LSnSp'

    var params = {
        symbol: 'XLMBTC',
        side: 'BUY',
        type: 'MARKET',
        quantity: 41,
        recvWindow: 5000,
        timestamp: Math.floor(Date.now() / 1000) * 1000
    };

    var queryString = $.param(params);

    var hmac = forge.hmac.create();
    hmac.start('sha256', secret);
    hmac.update(queryString);
    signature = hmac.digest().toHex();

    const url = "http://localhost:4567/order?" + queryString + "&signature=" + signature + "&api_key=" + api_key;

    /*
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        // document.getElementById("demo").innerHTML = this.responseText;
        obj = JSON.parse(this.responseText);
        console.log(JSON.stringify(obj, null, 2));
      }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
    */

    $(document).ready(function() {

      $('#plotlyGraph').hide();
      $('#plotlyGraphPlaceholder').show();
      $('#copyOrders').hide();
      $('#orderBox').show();

      $('#copyOrders').click(function(){
        alert('Orders Copied');
      });

      $("#generate_allocations").click(function(){

        document.getElementById("generate_allocations").disabled = true;

        $('#plotlyGraph').hide();
        $('#plotlyGraphPlaceholder').show();

        usdc_amount = document.getElementById('usdc_amount').value;
        limit = document.getElementById('limit').value;
        type = document.getElementById('type').value;

        allocation_specs = {
          limit: limit,
          type: type,
          usdc_amount: usdc_amount
        }

        fetch('http://localhost:4567/generate_allocations', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(allocation_specs)
          }).then(res=>res.json())
          .then(res => {
            console.log(res);
            console.log(res.orders);
            document.getElementById("orderBox").innerHTML = '<pre>' + JSON.stringify(res.orders,null,2) + '</pre>';
            $('#plotlyGraph').show();
            $('#plotlyGraphPlaceholder').hide();
            $('#copyOrders').show();
            document.getElementById("generate_allocations").disabled = false;

            var plotlyX = []
            var plotlyY = []
            var arrayLength = res.allocations.length;
            for (var i = 0; i < arrayLength; i++) {
              plotlyX.push(res.allocations[i]['symbol']);
              plotlyY.push(res.allocations[i]['precise_allocation_usdc']);
            }

                var plotlyData = [
                  {
                    x: plotlyX,
                    y: plotlyY,
                    type: 'bar'
                  }
                ];

                var layout = {
                  title: 'Allocations: Top ' + limit,
                  showlegend: false
                };

                Plotly.newPlot('plotlyGraph', plotlyData, layout, {displayModeBar: false});
          });
      });
    });

  </script>
</head>
<body>
  <h1>Accumul8.io</h1>
  <p><pre>Welcome. Accumul8.io is an allocation platform for Binance.</pre></p>
  <p><input type="number" id="usdc_amount" class="usdc_amount" placeholder="USDC Amount" min="100" max="500"></p>
  <p>
    <select name="type" id="type">
      <option value="coins">Coins Only</option>
      <option value="all">Coins and Tokens</option>
    </select>
  </p>
  <p>
    <select name="limit" id="limit">
      <option value=5>Top 5</option>
      <option value=6>Top 6</option>
      <option value=7>Top 7</option>
      <option value=8>Top 8</option>
      <option value=9>Top 9</option>
      <option value=10>Top 10</option>
      <option value=11>Top 11</option>
      <option value=12>Top 12</option>
      <option value=13>Top 13</option>
      <option value=14>Top 14</option>
      <option value=15>Top 15</option>
      <option value=16>Top 16</option>
      <option value=17>Top 17</option>
      <option value=18>Top 18</option>
      <option value=19>Top 19</option>
      <option value=20>Top 20</option>
      <option value=21>Top 21</option>
      <option value=22>Top 22</option>
      <option value=23>Top 23</option>
      <option value=24>Top 24</option>
      <option value=25>Top 25</option>
    </select>
  </p>
  <p><button id="generate_allocations">Generate Allocations</button></p>
  <hr size='1'>
  <p><div id="plotlyGraphPlaceholder" style="width:600px; height:250px; background-color:#eee; border:1px solid #ccc;">Allocation Chart will Appear Here.</div></p>
  <p><div id="plotlyGraph" style="width:600px; height:250px;"></div></p>
  <hr size='1'>
  <p><button id="copyOrders" class="btn" data-clipboard-action="copy" data-clipboard-target="#orderBox">Copy Orders</button></p>

  <div style="position:absolute; top:0; left:-500px;">
    <p><div id="orderBox"></div></p>
  </div>

</body>
</html>
