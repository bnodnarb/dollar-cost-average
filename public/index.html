<html>
<head>

<style>
  input, button, select {
    width: 250px;
    height: 30px;
  }
</style>

  <script src='https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js'></script>
  <script src = 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js'></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>

  <script>

  var orders;

    function showStepOne() {
      $('.stepOne').show();
      $('.stepTwo').hide();
      $('.stepThree').hide();
    }

    function showStepTwo() {
      $('.stepOne').hide();
      $('.stepTwo').show();
      $('.stepThree').hide();
    }

    function showStepThree() {
      $('.stepOne').hide();
      $('.stepTwo').hide();
      $('.stepThree').show();
    }

    $(document).ready(function() {

      showStepOne();

      $("#generate_allocations").click(function(){
        showStepTwo();
        usdc_amount = document.getElementById('usdc_amount').value;
        limit = document.getElementById('limit').value;
        type = document.getElementById('type').value;

        allocation_specs = {
          limit: limit,
          type: type,
          usdc_amount: usdc_amount
        }

        fetch('http://localhost:4567/generate_allocations', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(allocation_specs)}).then(res=>res.json()).then(res => {
            console.log(res);

            orders = res.orders;

            var plotlyX = []
            var plotlyY = []
            for (var i = 0; i < res.allocations.length; i++) {
              plotlyX.push(res.allocations[i]['symbol']);
              plotlyY.push(res.allocations[i]['precise_allocation_usdc']);
            }
            var plotlyData = [{x: plotlyX, y: plotlyY, type: 'bar'}];
            var layout = {title: 'Allocations: Top ' + limit, showlegend: false};
            Plotly.newPlot('plotlyGraph', plotlyData, layout, {displayModeBar: false});

        });
      });

      $("#generate_signed_orders").click(function(){
        api_key = document.getElementById('api_key').value;
        secret = document.getElementById('api_secret').value;

        for (var i = 0; i < orders.length; i++) {
          var order = orders[i];
          var params = {
              symbol: order.symbol,
              side: 'BUY',
              type: 'MARKET',
              quantity: order.quantity,
              recvWindow: 60000,
              timestamp: Math.floor(Date.now() / 1000) * 1000
          };

          queryString = Object.keys(params).map(function(k) {
              return encodeURIComponent(k) + '=' + encodeURIComponent(params[k])
          }).join('&')

          var hmac = forge.hmac.create();
          hmac.start('sha256', secret);
          hmac.update(queryString);
          signature = hmac.digest().toHex();

          orders[i].signedOrder = queryString + "&signature=" + signature + "&api_key=" + api_key;;
        }
        console.log(orders);
      });



    });

  </script>
</head>





<body>
  <h1>Accumul8.io</h1>
  <p><pre>Welcome. Accumul8.io is an allocation platform for Binance.</pre></p>
  <p><input type="number" id="usdc_amount" class="usdc_amount stepOne" placeholder="USDC Amount" min="100" max="500"></p>
  <p>
    <select name="type" id="type" class="stepOne">
      <option value="coins">Coins Only</option>
      <option value="all">Coins and Tokens</option>
    </select>
  </p>
  <p>
    <select name="limit" id="limit" class="stepOne">
      <option value=5>Top 5</option>
      <option value=6>Top 6</option>
      <option value=7>Top 7</option>
      <option value=8>Top 8</option>
      <option value=9>Top 9</option>
      <option value=10>Top 10</option>
      <option value=11>Top 11</option>
      <option value=12>Top 12</option>
      <option value=13>Top 13</option>
      <option value=14>Top 14</option>
      <option value=15>Top 15</option>
      <option value=16>Top 16</option>
      <option value=17>Top 17</option>
      <option value=18>Top 18</option>
      <option value=19>Top 19</option>
      <option value=20>Top 20</option>
    </select>
  </p>
  <p><button id="generate_allocations" class="stepOne">Generate Allocations</button></p>

  <p><div class="stepTwo" id="plotlyGraph" style="width:600px; height:250px;"></div></p>
  <p><input type="password" id="api_key" placeholder="Binance API Key" class="stepTwo"> <i class="stepTwo">Your Binance API Key</i></p>
  <p><input type="password" id="api_secret" placeholder="Binance API Secret" class="stepTwo"> <i class="stepTwo">Your Binance API Secret Key</i></p>
  <p><button id="generate_signed_orders" class="stepTwo">Generate Signed Orders</button></p>
</body>
</html>
