<html>
<head>

<style>
  input, button, select {
    width: 250px;
    height: 30px;
  }

  .hideAtLoad {
    display: none;
  }
</style>

  <script src='https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js'></script>
  <script src = 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js'></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script>

    var orders;

    function addTheLimits() {
      for (var i = 4; i <= 50; i++) {
        var x = document.getElementById("limit");
        var option = document.createElement("option");
        option.text = "Top " + i;
        option.value = i;
        x.add(option);
      }
    }

    function setCookie(name,value,days) {
      var expires = "";
      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }

    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
      }
      return null;
    }

    function eraseCookie(name) {
      document.cookie = name+'=; Max-Age=-99999999;';
    }

    function showStepOne() {
      $('.stepOne').show();
      $('.stepTwo').hide();
      $('.stepThree').hide();
      $('.stepFour').hide();
    }

    function showStepTwo() {
      $('.stepOne').hide();
      $('.stepTwo').show();
      $('.stepThree').hide();
      $('.stepFour').hide();
    }

    function showStepThree() {
      $('.stepOne').hide();
      $('.stepTwo').hide();
      $('.stepThree').show();
      $('.stepFour').hide();
    }

    function showStepFour() {
      $('.stepOne').hide();
      $('.stepTwo').hide();
      $('.stepThree').hide();
      $('.stepFour').show();
    }

    $(document).ready(function() {

      showStepOne();
      addTheLimits();
      $("#generate_allocations").click(function(){
        usdc_amount = document.getElementById('usdc_amount').value;
        limit = document.getElementById('limit').value;
        type = document.getElementById('type').value;

        allocation_specs = {
          limit: limit,
          type: type,
          usdc_amount: usdc_amount
        }

        fetch('http://localhost:4567/generate_allocations', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(allocation_specs)}).then(res=>res.json()).then(res => {
            // console.log(res);
            showStepTwo();

            var binance_api_key = getCookie('bk1');
            if (binance_api_key) {
              document.getElementById('api_key').value = binance_api_key;
            }
            var binance_api_secret = getCookie('bk2');
            if (binance_api_secret) {
              document.getElementById('api_secret').value = binance_api_secret;
            }

            orders = res.orders;

            var plotlyX = []
            var plotlyY = []
            for (var i = 0; i < res.allocations.length; i++) {
              plotlyX.push(res.allocations[i]['symbol']);
              plotlyY.push(res.allocations[i]['quantity_rounded_down_by_step_size']);
            }
            var plotlyData = [{x: plotlyX, y: plotlyY, type: 'bar'}];
            var layout = {title: 'Allocations: Top ' + limit, showlegend: false};
            Plotly.newPlot('plotlyGraph', plotlyData, layout, {displayModeBar: false});

        });
      });

      $("#generate_signed_orders").click(function(){
        showStepThree();
        api_key = document.getElementById('api_key').value;
        api_secret = document.getElementById('api_secret').value;

        store_api_details = document.getElementById('store_api_details').checked;
        if (store_api_details === true) {
          setCookie('bk1',api_key,7);
          setCookie('bk2',api_secret,7);
        } else {
          eraseCookie('bk1');
          eraseCookie('bk2');
        }


        for (var i = 0; i < orders.length; i++) {
          var order = orders[i];
          var params = {
              symbol: order.symbol,
              side: 'BUY',
              type: 'MARKET',
              quantity: order.quantity,
              recvWindow: 60000,
              timestamp: Math.floor(Date.now() / 1000) * 1000
          };

          queryString = Object.keys(params).map(function(k) {
              return encodeURIComponent(k) + '=' + encodeURIComponent(params[k])
          }).join('&')

          var hmac = forge.hmac.create();
          hmac.start('sha256', api_secret);
          hmac.update(queryString);
          signature = hmac.digest().toHex();

          orders[i].symbol = order.symbol;
          orders[i].side = 'BUY';
          orders[i].type = 'MARKET';
          orders[i].quantity = order.quantity;
          orders[i].recvWindow = 60000;
          orders[i].timestamp = Math.floor(Date.now() / 1000) * 1000;
          orders[i].signature = signature;
          orders[i].api_key = api_key
        }
        // console.log(orders);
        document.getElementById("signed_orders").innerHTML = '<pre>' + JSON.stringify(orders,null,2) + '</pre>';
      });

      $("#place_orders").click(function(){

        fetch('http://localhost:4567/place_orders', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(orders)}).then(res=>res.json()).then(res => {
          showStepFour();
          // console.log(res);
          orders = res;
          for (var i = 0; i < res.length; i++) {
            var order = orders[i];
            var ul = document.getElementById("list");
            var li = document.createElement("li");
            if (order.response.status === 'Success') {
              li.appendChild(document.createTextNode("Order Successful | " + order.symbol + " | " + order.response.message));
            }
            if (order.response.status === 'Error') {
              li.appendChild(document.createTextNode("Error | " + order.symbol + " | " + order.response.message));
            }
            ul.appendChild(li);
          }
        });
      });

      $(".begin_again").click(function(){
        document.getElementById('usdc_amount').value = null;
        document.getElementById('limit').value = "4";
        document.getElementById('type').value = "coins";
        showStepOne();
      });

    });

  </script>
</head>

<body>
  <h1>Accumul8.io</h1>
  <p><pre>Welcome. Accumul8.io is an allocation platform for Binance.</pre></p>
  <hr size="1">

  <div class="stepOne">
    <p><input type="number" id="usdc_amount" class="usdc_amount" placeholder="USDC Amount" min="100" max="500"></p>
    <p>
      <select name="type" id="type">
        <option value="coins">Coins Only</option>
        <option value="all">Coins and Tokens</option>
      </select>
    </p>
    <p>
      <select name="limit" id="limit">
      </select>
    </p>
    <p><button id="generate_allocations">Generate Allocations</button></p>
  </div>

  <div class="stepTwo hideAtLoad">
    <p><div id="plotlyGraph" style="width:1000px; height:350px;"></div></p>
    <fieldset>
      <legend>Binance API Details</legend>
      <p><input type="password" id="api_key" placeholder="Binance API Key"></p>
      <p><input type="password" id="api_secret" placeholder="Binance API Secret"></p>
      <p><input type="checkbox" id="store_api_details">
      <label for="store_api_details">Check to keep API details in browser for 7 days (unchecking will erase)</label></p>
    </fieldset>
    <p><button id="generate_signed_orders">Generate Signed Orders</button></p>
    <p><button class="begin_again">Cancel</button></p>
  </div>

  <div class="stepThree hideAtLoad">
    <p><div id="signed_orders"></div></p>
    <p><button id="place_orders">Place Orders</button></p>
    <p><button class="begin_again">Cancel</button></p>
  </div>

  <div class="stepFour hideAtLoad">
    <p>Orders Sent to Binance</p>
    <p>
      <ul id="list">
      </ul>
    </p>
    <p><button class="begin_again">Start Again</button></p>
</body>
</html>
